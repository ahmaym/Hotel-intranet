{% extends "base.html" %}
{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6 flex-wrap gap-4">
  <div>
    <h1 class="text-2xl font-bold text-slate-800">Support Tickets</h1>
    <p class="text-slate-500 text-sm mt-1">Submit and track IT, HR, and Engineering requests</p>
  </div>
  <div class="flex items-center gap-2 text-sm">
    <span class="px-3 py-1.5 bg-red-100 text-red-700 rounded-full font-medium">Open</span>
    <span class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-full font-medium">In Progress</span>
    <span class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-full font-medium">Closed</span>
  </div>
</div>

<div class="grid lg:grid-cols-3 gap-6">
  <!-- Create Ticket Form -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm sticky top-24">
      <div class="px-5 py-4 bg-gradient-to-r from-sky-50 to-blue-50 border-b border-sky-100 rounded-t-xl">
        <h2 class="font-semibold text-sky-800 flex items-center gap-2">
          <i data-lucide="plus-circle" class="w-5 h-5"></i> New Ticket
        </h2>
      </div>
      <form method="POST" action="{{ url_for('tickets') }}" class="p-5 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Title</label>
          <input type="text" name="title" required placeholder="Brief issue summary..."
            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-slate-800 placeholder-slate-400">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Description</label>
          <textarea name="description" rows="4" required placeholder="Describe the issue in detail..."
            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-slate-800 placeholder-slate-400 resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Assign to Department</label>
          <select name="department" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-white text-slate-800">
            <option value="IT">üñ•Ô∏è IT Department</option>
            <option value="HR">üë• HR Department</option>
            <option value="ENG">‚öôÔ∏è Engineering (ENG)</option>
          </select>
        </div>
        <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors shadow-sm">
          <i data-lucide="send" class="w-4 h-4"></i> Submit Ticket
        </button>
      </form>
    </div>
  </div>

  <!-- Tickets List -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
      <div class="px-5 py-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-semibold text-slate-800 flex items-center gap-2">
          <i data-lucide="list" class="w-5 h-5 text-slate-500"></i> All Tickets
        </h2>
        <span class="text-xs text-slate-500">{{ tickets|length }} ticket(s)</span>
      </div>

      <div class="p-5 border-b border-slate-200 bg-white">
        <form method="GET" action="{{ url_for('tickets') }}" class="flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label class="sr-only" for="q">Search</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
              </div>
              <input id="q" name="q" value="{{ q or '' }}" placeholder="Search by ticket #, title, description, requester..."
                class="w-full pl-9 pr-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-sm text-slate-800 placeholder-slate-400" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 sm:flex sm:items-center sm:gap-3">
            <div>
              <label class="sr-only" for="status">Status</label>
              <select id="status" name="status"
                class="w-full px-3 py-2.5 border border-slate-200 rounded-lg bg-white text-sm text-slate-700 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <option value="" {% if not status_filter %}selected{% endif %}>All statuses</option>
                <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
              </select>
            </div>

            <div>
              <label class="sr-only" for="sort">Sort</label>
              <select id="sort" name="sort"
                class="w-full px-3 py-2.5 border border-slate-200 rounded-lg bg-white text-sm text-slate-700 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <option value="newest" {% if sort != 'oldest' %}selected{% endif %}>Newest first</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest first</option>
              </select>
            </div>
          </div>

          <div class="flex gap-2">
            <button type="submit"
              class="inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 hover:bg-slate-900 text-white text-sm font-medium rounded-lg transition-colors">
              <i data-lucide="filter" class="w-4 h-4"></i> Apply
            </button>
            <a href="{{ url_for('tickets') }}"
              class="inline-flex items-center justify-center px-4 py-2.5 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium rounded-lg border border-slate-200 transition-colors">
              Reset
            </a>
          </div>
        </form>
      </div>

      {% if tickets %}
      <div class="divide-y divide-slate-100">
        {% for t in tickets %}
        <div class="p-5 hover:bg-slate-50 transition-colors">
          <div class="flex items-start justify-between gap-4 mb-3">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <h3 class="font-semibold text-slate-800">{{ t['title'] }}</h3>
                {% if t['ticket_number'] %}
                <span class="px-2 py-0.5 text-xs font-semibold bg-slate-100 text-slate-700 rounded-full">{{ t['ticket_number'] }}</span>
                {% endif %}
                <span class="px-2 py-0.5 text-xs font-medium rounded-full
                  {% if t['assigned_department'] == 'IT' %}bg-blue-100 text-blue-700
                  {% elif t['assigned_department'] == 'HR' %}bg-purple-100 text-purple-700
                  {% else %}bg-orange-100 text-orange-700{% endif %}">
                  {{ t['assigned_department'] }}
                </span>
              </div>
              <p class="text-slate-600 text-sm line-clamp-2">{{ t['description'] }}</p>
            </div>
            <div class="flex-shrink-0">
              {% if t['status'] == 'open' %}
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">
                <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Open
              </span>
              {% elif t['status'] == 'in_progress' %}
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">
                <span class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span> In Progress
              </span>
              {% else %}
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium">
                <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Closed
              </span>
              {% endif %}
            </div>
          </div>
          
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-4 text-xs text-slate-500">
              <span class="flex items-center gap-1">
                <i data-lucide="user" class="w-3.5 h-3.5"></i> {{ t['username'] or t['created_by'] }}
              </span>
              <span class="flex items-center gap-1">
                <i data-lucide="calendar" class="w-3.5 h-3.5"></i> {{ t['created_at'] }}
              </span>
            </div>
            
            {% if user_dept == t['assigned_department'] %}
            <form method="POST" action="{{ url_for('update_ticket_status', ticket_id=t['id']) }}" class="flex items-center gap-2">
              <select name="status" class="text-xs px-2 py-1.5 border border-slate-200 rounded-lg bg-white text-slate-700 focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <option value="open" {% if t['status'] == 'open' %}selected{% endif %}>Open</option>
                <option value="in_progress" {% if t['status'] == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="closed" {% if t['status'] == 'closed' %}selected{% endif %}>Closed</option>
              </select>
              <button type="submit" class="p-1.5 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-lg transition-colors">
                <i data-lucide="check" class="w-4 h-4"></i>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="p-12 text-center">
        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="ticket" class="w-8 h-8 text-slate-400"></i>
        </div>
        <h3 class="font-medium text-slate-700 mb-1">No tickets found</h3>
        <p class="text-sm text-slate-500">Create your first ticket using the form</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}