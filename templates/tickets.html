{% extends "base.html" %}
{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6 flex-wrap gap-4">
  <div>
    <h1 class="text-2xl font-bold text-slate-800">Support Tickets</h1>
    <p class="text-slate-500 text-sm mt-1">Submit and track IT, HR, and Engineering requests</p>
  </div>
  <div class="flex items-center gap-2 text-xs">
    <span class="flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-full font-medium"><span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Open</span>
    <span class="flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full font-medium"><span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span> In Progress</span>
    <span class="flex items-center gap-1.5 px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-full font-medium"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Closed</span>
  </div>
</div>

<!-- Collapsible Create Ticket Form -->
<div class="mb-6">
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
    <button type="button" onclick="toggleNewTicketForm()" class="w-full px-5 py-4 flex items-center justify-between bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl hover:from-sky-100 hover:to-blue-100 transition-colors">
      <h2 class="font-semibold text-sky-800 flex items-center gap-2">
        <i data-lucide="plus-circle" class="w-5 h-5"></i> Create New Ticket
      </h2>
      <i data-lucide="chevron-down" id="new-ticket-chevron" class="w-5 h-5 text-sky-600 transition-transform"></i>
    </button>
    <div id="new-ticket-form" class="hidden border-t border-sky-100">
      <form method="POST" action="{{ url_for('tickets') }}" class="p-5">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1.5">Title</label>
            <input type="text" name="title" required placeholder="Brief issue summary..."
              class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-slate-800 placeholder-slate-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1.5">Department</label>
            <select name="department" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-white text-slate-800">
              <option value="IT">IT Department</option>
              <option value="HR">HR Department</option>
              <option value="ENG">Engineering (ENG)</option>
            </select>
          </div>
          <div class="flex items-end">
            <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors shadow-sm">
              <i data-lucide="send" class="w-4 h-4"></i> Submit
            </button>
          </div>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Description</label>
          <textarea name="description" rows="3" required placeholder="Describe the issue in detail..."
            class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-slate-800 placeholder-slate-400 resize-none"></textarea>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tickets Table Container -->
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
  <!-- Table Header with Search/Filter -->
  <div class="px-5 py-4 bg-slate-50 border-b border-slate-200">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div class="flex items-center gap-3">
        <h2 class="font-semibold text-slate-800 flex items-center gap-2">
          <i data-lucide="list" class="w-5 h-5 text-slate-500"></i> All Tickets
        </h2>
        <span class="px-2.5 py-1 bg-slate-200 text-slate-700 text-xs font-semibold rounded-full">{{ tickets|length }}</span>
      </div>
      <form method="GET" action="{{ url_for('tickets') }}" class="flex flex-wrap items-center gap-3">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
          </div>
          <input name="q" value="{{ q or '' }}" placeholder="Search tickets..."
            class="w-48 pl-9 pr-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-sm text-slate-800 placeholder-slate-400" />
        </div>
        <select name="status" class="px-3 py-2 border border-slate-200 rounded-lg bg-white text-sm text-slate-700 focus:ring-2 focus:ring-sky-500">
          <option value="" {% if not status_filter %}selected{% endif %}>All Status</option>
          <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
          <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
          <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
        </select>
        <select name="sort" class="px-3 py-2 border border-slate-200 rounded-lg bg-white text-sm text-slate-700 focus:ring-2 focus:ring-sky-500">
          <option value="newest" {% if sort != 'oldest' %}selected{% endif %}>Newest</option>
          <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest</option>
        </select>
        <button type="submit" class="px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white text-sm font-medium rounded-lg transition-colors">
          <i data-lucide="filter" class="w-4 h-4"></i>
        </button>
        <a href="{{ url_for('tickets') }}" class="px-3 py-2 text-slate-600 hover:text-slate-800 text-sm font-medium">Reset</a>
      </form>
    </div>
  </div>

  {% set is_admin_user = session.get('user_id', '')|lower == 'ahmed.ayman' %}

  {% if tickets %}
  <!-- Bulk Delete Form (Ahmed.Ayman only) -->
  <form id="bulk-delete-form" method="POST" action="{{ url_for('bulk_delete_tickets') }}">

  <!-- Bulk Delete Bar (Ahmed.Ayman only) -->
  {% if is_admin_user %}
  <div id="bulk-delete-bar" class="hidden px-5 py-3 bg-red-50 border-b border-red-200 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="text-sm font-medium text-red-700"><span id="selected-count">0</span> ticket(s) selected</span>
    </div>
    <div class="flex items-center gap-2">
      <button type="button" onclick="clearSelection()" class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-slate-800 bg-white border border-slate-200 rounded-lg transition-colors">Clear Selection</button>
      <button type="submit" onclick="return confirm('Are you sure you want to permanently delete the selected tickets? This action cannot be undone.')" class="px-4 py-1.5 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors flex items-center gap-2">
        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Selected
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Professional Table -->
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-slate-100 border-b border-slate-200">
          {% if is_admin_user %}<th class="px-3 py-3 text-center"><input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="w-4 h-4 rounded border-slate-300 text-red-600 focus:ring-red-500 cursor-pointer"></th>{% endif %}
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Ticket</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider max-w-xs">Description</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Created By</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Created At</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Open Duration</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Update</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Assigned To</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Assign</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for t in tickets %}
        <tr class="hover:bg-slate-50 transition-colors">
          <!-- Checkbox for bulk delete (Ahmed.Ayman only) -->
          {% if is_admin_user %}<td class="px-3 py-4 text-center"><input type="checkbox" name="ticket_ids" value="{{ t['id'] }}" onchange="updateSelection()" class="ticket-checkbox w-4 h-4 rounded border-slate-300 text-red-600 focus:ring-red-500 cursor-pointer"></td>{% endif %}
          <!-- Ticket Title -->
          <td class="px-4 py-4">
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2">
                {% if t['ticket_number'] %}<span class="px-2 py-0.5 text-xs font-semibold bg-slate-200 text-slate-700 rounded">{{ t['ticket_number'] }}</span>{% endif %}
                <span class="px-2 py-0.5 text-xs font-medium rounded {% if t['assigned_department'] == 'IT' %}bg-blue-100 text-blue-700{% elif t['assigned_department'] == 'HR' %}bg-purple-100 text-purple-700{% else %}bg-orange-100 text-orange-700{% endif %}">{{ t['assigned_department'] }}</span>
                {% if ticket_comments[t['id']] %}<button type="button" onclick="openHistoryModal('{{ t['id'] }}')" class="px-1.5 py-0.5 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 rounded transition-colors" title="View History"><i data-lucide="history" class="w-3 h-3 inline"></i> {{ ticket_comments[t['id']]|length }}</button>{% endif %}
              </div>
              <span class="font-semibold text-slate-800 text-sm">{{ t['title'] }}</span>
            </div>
          </td>
          <!-- Description -->
          <td class="px-4 py-4 max-w-xs">
            <p class="text-slate-600 text-sm truncate" title="{{ t['description'] }}">{{ t['description'][:60] }}{% if t['description']|length > 60 %}...{% endif %}</p>
          </td>
          <!-- Created By -->
          <td class="px-4 py-4">
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 bg-slate-200 rounded-full flex items-center justify-center">
                <span class="text-slate-600 font-medium text-xs">{{ (t['username'] or t['created_by'])[:1]|upper }}</span>
              </div>
              <span class="text-sm text-slate-700">{{ t['username'] or t['created_by'] }}</span>
            </div>
          </td>
          <!-- Created At -->
          <td class="px-4 py-4">
            <div class="text-sm text-slate-600">
              <div>{{ t['created_at'][:10] }}</div>
              <div class="text-xs text-slate-400">{{ t['created_at'][11:16] if t['created_at']|length > 11 else '' }}</div>
            </div>
          </td>
          <!-- Open Duration -->
          <td class="px-4 py-4">
            {% if t['status'] != 'closed' %}
            <div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-amber-50 border border-amber-200 rounded-lg">
              <i data-lucide="clock" class="w-3.5 h-3.5 text-amber-600"></i>
              <span class="text-sm font-semibold text-amber-700">{{ get_time_elapsed_detailed(t['created_at']) }}</span>
            </div>
            {% else %}<span class="text-sm text-slate-400">—</span>{% endif %}
          </td>
          <!-- Status -->
          <td class="px-4 py-4">
            {% if t['status'] == 'open' %}
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium"><span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Open</span>
            {% elif t['status'] == 'in_progress' %}
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium"><span class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span> In Progress</span>
            {% else %}
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Closed</span>
            {% endif %}
          </td>
          <!-- Update Status Action -->
          <td class="px-4 py-4 text-center">
            {% set is_super_user = session.get('user_id', '')|lower == 'ahmed.ayman' %}
            {% set is_assigned_user = t['assigned_to_username'] and session.get('user_id', '')|lower == t['assigned_to_username']|lower %}
            {% set can_update = is_super_user or (t['assigned_to_username'] and is_assigned_user) or (not t['assigned_to_username'] and user_dept == t['assigned_department']) %}
            {% if can_update and t['status'] != 'closed' %}
            <button type="button" onclick="openUpdateModal('{{ t['id'] }}', '{{ t['status'] }}')" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-sky-100 hover:bg-sky-200 text-sky-700 text-xs font-medium rounded-lg transition-colors">
              <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> Update
            </button>
            {% else %}<span class="text-slate-400 text-xs">—</span>{% endif %}
          </td>
          <!-- Assigned To -->
          <td class="px-4 py-4">
            {% if t['assigned_to_username'] %}
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 bg-indigo-100 rounded-full flex items-center justify-center">
                <span class="text-indigo-700 font-medium text-xs">{{ t['assigned_to_username'][:1]|upper }}</span>
              </div>
              <div>
                <div class="text-sm font-medium text-slate-800">{{ t['assigned_to_username'] }}</div>
                <div class="text-xs text-slate-400">{{ t['assigned_at'][:10] if t['assigned_at'] else '' }}</div>
              </div>
              {% if user_dept == t['assigned_department'] %}
              <form method="POST" action="{{ url_for('unassign_ticket', ticket_id=t['id']) }}" class="inline ml-1">
                <button type="submit" onclick="return confirm('Remove assignment?')" class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="Remove">
                  <i data-lucide="x" class="w-3.5 h-3.5"></i>
                </button>
              </form>
              {% endif %}
            </div>
            {% else %}<span class="text-slate-400 text-sm">Unassigned</span>{% endif %}
          </td>
          <!-- Assign Ticket Action -->
          <td class="px-4 py-4 text-center">
            {% if user_dept == t['assigned_department'] and not t['assigned_to_username'] and t['status'] != 'closed' %}
            <button type="button" onclick="openAssignModal('{{ t['id'] }}')" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-medium rounded-lg transition-colors">
              <i data-lucide="user-plus" class="w-3.5 h-3.5"></i> Assign
            </button>
            {% elif t['assigned_to_username'] and user_dept == t['assigned_department'] and t['status'] != 'closed' %}
            <button type="button" onclick="openAssignModal('{{ t['id'] }}')" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-medium rounded-lg transition-colors">
              <i data-lucide="user-cog" class="w-3.5 h-3.5"></i> Reassign
            </button>
            {% else %}<span class="text-slate-400 text-xs">—</span>{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  </form>
  {% else %}
  <div class="p-12 text-center">
    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <i data-lucide="ticket" class="w-8 h-8 text-slate-400"></i>
    </div>
    <h3 class="font-medium text-slate-700 mb-1">No tickets found</h3>
    <p class="text-sm text-slate-500">Create your first ticket using the form above</p>
  </div>
  {% endif %}
</div>

<!-- Update Status Modal -->
<div id="update-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-slate-900/50 transition-opacity" onclick="closeUpdateModal()"></div>
    <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full mx-auto z-10">
      <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Update Ticket Status</h3>
        <button type="button" onclick="closeUpdateModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="update-form" method="POST" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">New Status</label>
          <select name="status" id="modal-status" required onchange="checkModalClosing()" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 bg-white text-slate-800">
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Comment <span id="modal-required-label" class="text-red-600"></span></label>
          <textarea name="comment" id="modal-comment" rows="3" placeholder="Add a comment..." class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 text-slate-800 placeholder-slate-400 resize-none"></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors"><i data-lucide="check" class="w-4 h-4"></i> Update</button>
          <button type="button" onclick="closeUpdateModal()" class="px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Assign Ticket Modal -->
<div id="assign-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-slate-900/50 transition-opacity" onclick="closeAssignModal()"></div>
    <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full mx-auto z-10">
      <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Assign Ticket</h3>
        <button type="button" onclick="closeAssignModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="assign-form" method="POST" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1.5">Search Active Directory</label>
          <div class="relative">
            <input type="text" id="modal-user-search" placeholder="Type at least 2 characters..." oninput="searchADUsersModal()" autocomplete="off" class="w-full px-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white text-slate-800 placeholder-slate-400">
            <div id="modal-user-dropdown" class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
          </div>
          <input type="hidden" name="assign_to_user" id="modal-selected-user">
        </div>
        <div id="modal-selected-display" class="hidden p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center"><span id="modal-selected-initial" class="text-indigo-700 font-medium text-sm"></span></div>
            <div>
              <div id="modal-selected-name" class="text-sm font-medium text-slate-800"></div>
              <div id="modal-selected-username" class="text-xs text-slate-500"></div>
            </div>
            <button type="button" onclick="clearSelectedUser()" class="ml-auto p-1 text-slate-400 hover:text-red-500 rounded"><i data-lucide="x" class="w-4 h-4"></i></button>
          </div>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="submit" id="assign-submit-btn" disabled class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors"><i data-lucide="user-check" class="w-4 h-4"></i> Assign</button>
          <button type="button" onclick="closeAssignModal()" class="px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="history-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-slate-900/50 transition-opacity" onclick="closeHistoryModal()"></div>
    <div class="relative bg-white rounded-xl shadow-xl max-w-lg w-full mx-auto z-10">
      <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-slate-500"></i> Ticket History</h3>
        <button type="button" onclick="closeHistoryModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="history-content" class="p-6 max-h-96 overflow-y-auto">
        <!-- History entries will be populated here -->
      </div>
      <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-xl">
        <button type="button" onclick="closeHistoryModal()" class="w-full px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-colors">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Ticket History Data (for JavaScript) -->
<script type="application/json" id="ticket-history-data">
{
  {% for t in tickets %}
  "{{ t['id'] }}": [
    {% for log in ticket_comments[t['id']] %}
    {
      "username": "{{ log['username'] }}",
      "status_change": "{{ log['status_change'] }}",
      "comment": "{{ log['comment']|default('', true)|replace('\n', ' ')|replace('"', '\\"') }}",
      "created_at": "{{ log['created_at'] }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]{% if not loop.last %},{% endif %}
  {% endfor %}
}
</script>

<script>
let searchTimeout = null;
let currentTicketId = null;
let historyData = {};

// Load history data
try {
  historyData = JSON.parse(document.getElementById('ticket-history-data').textContent);
} catch(e) { console.error('Failed to parse history data:', e); }

// Toggle new ticket form
function toggleNewTicketForm() {
  const form = document.getElementById('new-ticket-form');
  const chevron = document.getElementById('new-ticket-chevron');
  form.classList.toggle('hidden');
  chevron.classList.toggle('rotate-180');
}

// Update Status Modal
function openUpdateModal(ticketId, currentStatus) {
  currentTicketId = ticketId;
  const modal = document.getElementById('update-modal');
  const form = document.getElementById('update-form');
  const statusSelect = document.getElementById('modal-status');
  form.action = '/ticket/' + ticketId + '/status';
  statusSelect.value = currentStatus;
  checkModalClosing();
  modal.classList.remove('hidden');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeUpdateModal() {
  document.getElementById('update-modal').classList.add('hidden');
  document.getElementById('modal-comment').value = '';
  currentTicketId = null;
}

function checkModalClosing() {
  const statusSelect = document.getElementById('modal-status');
  const requiredLabel = document.getElementById('modal-required-label');
  const commentField = document.getElementById('modal-comment');
  if (statusSelect.value === 'closed') {
    requiredLabel.textContent = '(required)';
    commentField.required = true;
  } else {
    requiredLabel.textContent = '';
    commentField.required = false;
  }
}

// Assign Ticket Modal
function openAssignModal(ticketId) {
  currentTicketId = ticketId;
  const modal = document.getElementById('assign-modal');
  const form = document.getElementById('assign-form');
  form.action = '/ticket/' + ticketId + '/assign';
  clearSelectedUser();
  document.getElementById('modal-user-search').value = '';
  document.getElementById('modal-user-dropdown').classList.add('hidden');
  modal.classList.remove('hidden');
  document.getElementById('modal-user-search').focus();
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeAssignModal() {
  document.getElementById('assign-modal').classList.add('hidden');
  clearSelectedUser();
  currentTicketId = null;
}

async function searchADUsersModal() {
  const searchInput = document.getElementById('modal-user-search');
  const dropdown = document.getElementById('modal-user-dropdown');
  const searchTerm = searchInput.value.trim();
  if (searchTimeout) clearTimeout(searchTimeout);
  if (searchTerm.length >= 2) {
    dropdown.innerHTML = '<div class="p-3 text-sm text-slate-500 flex items-center gap-2"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Searching AD...</div>';
    dropdown.classList.remove('hidden');
  } else if (searchTerm.length > 0) {
    dropdown.innerHTML = '<div class="p-3 text-sm text-slate-500">Type at least 2 characters</div>';
    dropdown.classList.remove('hidden');
    return;
  } else {
    dropdown.classList.add('hidden');
    return;
  }
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch('/api/ticket-users/search?search=' + encodeURIComponent(searchTerm));
      const users = await response.json();
      if (users.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-sm text-slate-500">No users found</div>';
      } else {
        dropdown.innerHTML = users.map(user => `
          <div class="p-2.5 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 last:border-0" onclick="selectModalUser('${user.username}', '${user.display_name.replace(/'/g, "\\'")}')">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center"><span class="text-indigo-700 font-medium text-sm">${user.display_name.charAt(0).toUpperCase()}</span></div>
              <div><div class="text-sm font-medium text-slate-800">${user.display_name}</div><div class="text-xs text-slate-500">${user.username} • ${user.department || 'No dept'}</div></div>
            </div>
          </div>
        `).join('');
      }
      dropdown.classList.remove('hidden');
    } catch (error) {
      dropdown.innerHTML = '<div class="p-3 text-sm text-red-500">Error searching AD</div>';
      dropdown.classList.remove('hidden');
    }
  }, 300);
}

function selectModalUser(username, displayName) {
  document.getElementById('modal-selected-user').value = username;
  document.getElementById('modal-user-search').value = '';
  document.getElementById('modal-user-dropdown').classList.add('hidden');
  document.getElementById('modal-selected-initial').textContent = displayName.charAt(0).toUpperCase();
  document.getElementById('modal-selected-name').textContent = displayName;
  document.getElementById('modal-selected-username').textContent = username;
  document.getElementById('modal-selected-display').classList.remove('hidden');
  document.getElementById('assign-submit-btn').disabled = false;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function clearSelectedUser() {
  document.getElementById('modal-selected-user').value = '';
  document.getElementById('modal-selected-display').classList.add('hidden');
  document.getElementById('assign-submit-btn').disabled = true;
}

// History Modal
function openHistoryModal(ticketId) {
  const modal = document.getElementById('history-modal');
  const content = document.getElementById('history-content');
  const entries = historyData[ticketId] || [];
  
  if (entries.length === 0) {
    content.innerHTML = '<p class="text-slate-500 text-center py-4">No history entries found.</p>';
  } else {
    content.innerHTML = '<div class="space-y-4">' + entries.map(entry => `
      <div class="border-l-4 border-sky-400 pl-4 py-2">
        <div class="flex items-start justify-between gap-2">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-sky-100 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-sky-700 font-medium text-sm">${entry.username.charAt(0).toUpperCase()}</span>
            </div>
            <div>
              <p class="text-sm"><span class="font-semibold text-slate-800">${entry.username}</span> <span class="text-slate-600">${entry.status_change}</span></p>
              <p class="text-xs text-slate-400">${entry.created_at}</p>
            </div>
          </div>
        </div>
        ${entry.comment ? `<div class="mt-2 ml-10 p-2.5 bg-slate-50 rounded-lg border border-slate-200"><p class="text-sm text-slate-700 italic">"${entry.comment}"</p></div>` : ''}
      </div>
    `).join('') + '</div>';
  }
  
  modal.classList.remove('hidden');
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeHistoryModal() {
  document.getElementById('history-modal').classList.add('hidden');
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeUpdateModal();
    closeAssignModal();
    closeHistoryModal();
  }
});

// Bulk Delete Selection Functions (Ahmed.Ayman only)
function toggleSelectAll() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.ticket-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateSelection();
}

function updateSelection() {
  const checkboxes = document.querySelectorAll('.ticket-checkbox:checked');
  const count = checkboxes.length;
  const bar = document.getElementById('bulk-delete-bar');
  const countSpan = document.getElementById('selected-count');
  const selectAll = document.getElementById('select-all');
  
  if (bar) {
    if (count > 0) {
      bar.classList.remove('hidden');
      countSpan.textContent = count;
    } else {
      bar.classList.add('hidden');
    }
  }
  
  // Update select-all checkbox state
  if (selectAll) {
    const allCheckboxes = document.querySelectorAll('.ticket-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
  }
  
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function clearSelection() {
  const checkboxes = document.querySelectorAll('.ticket-checkbox');
  const selectAll = document.getElementById('select-all');
  checkboxes.forEach(cb => cb.checked = false);
  if (selectAll) selectAll.checked = false;
  updateSelection();
}
</script>
{% endblock %}