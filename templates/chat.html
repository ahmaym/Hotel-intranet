{% extends "base.html" %}
{% block content %}
<style>
  /* ====== CHAT NOTIFICATIONS ====== */
  .notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-left: 4px solid #2e7d32;
    font-weight: 500;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px) scale(0.8);
      opacity: 0;
    }
    to {
      transform: translateX(0) scale(1);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }

  .notification.error {
    background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
    border-left-color: #c62828;
  }

  .notification.info {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    border-left-color: #0d47a1;
  }

  /* ====== CHAT LAYOUT ====== */
  .chat-container {
    display: flex;
    height: 75vh;
    gap: 0;
  }

  .chat-sidebar {
    width: 300px;
    background: #fff;
    border-right: 1px solid #ecf0f1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-search {
    padding: 14px;
    border: 2px solid #ecf0f1;
    border-radius: 0;
    background: #f8f9fa;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
    transition: all 0.3s ease;
    border-bottom: 2px solid #ecf0f1;
  }

  .chat-search:focus {
    outline: none;
    background: #fff;
    border-color: #667eea;
    box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.1);
  }

  #user-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  /* ====== USER ITEMS ====== */
  .user-item {
    padding: 14px;
    border-bottom: 1px solid #ecf0f1;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fff;
  }

  .user-item:hover {
    background: #f8f9fa;
    padding-left: 18px;
  }

  .user-item.active {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-right: 4px solid #667eea;
    padding-right: 10px;
  }

  .user-item.recent {
    background: linear-gradient(135deg, #dcfce7 0%, #c8e6c9 100%);
    border-left: 4px solid #28a745;
    padding-left: 10px;
  }

  .user-name-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .user-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
  }

  .user-department {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 4px;
  }

  .unread-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-size: 12px;
    font-weight: bold;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(245, 87, 108, 0.4);
  }

  .recent-users-header {
    padding: 12px 14px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 12px;
    text-transform: uppercase;
    border-bottom: 2px solid #ecf0f1;
    margin: 0;
    background: #f8f9fa;
    letter-spacing: 0.5px;
  }

  /* ====== CHAT MAIN AREA ====== */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
  }

  .chat-header {
    padding: 16px 20px;
    border-bottom: 2px solid #ecf0f1;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-header h4 {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
    font-size: 16px;
  }

  .messages-box {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: #f8f9fa;
  }

  .message {
    display: flex;
    gap: 10px;
    animation: messageSlide 0.3s ease;
    max-width: 70%;
  }

  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message.sent {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .message-content {
    padding: 12px 14px;
    border-radius: 12px;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .message.received .message-content {
    background: #fff;
    color: #2c3e50;
    border-left: 3px solid #667eea;
  }

  .message.sent .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .message-sender {
    font-size: 12px;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 4px;
  }

  .message-time {
    font-size: 11px;
    color: #999;
    margin-top: 4px;
  }

  .message.sent .message-time {
    color: rgba(255, 255, 255, 0.7);
  }

  .empty-chat {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #999;
    font-size: 16px;
    text-align: center;
  }

  /* ====== CHAT INPUT ====== */
  .chat-input {
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    border-top: 2px solid #ecf0f1;
    background: #fff;
  }

  .chat-input input {
    flex: 1;
    padding: 12px 14px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .chat-input input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .chat-input button {
    padding: 12px 24px;
    white-space: nowrap;
  }

  /* ====== SCROLLBAR ====== */
  #user-list::-webkit-scrollbar,
  .messages-box::-webkit-scrollbar {
    width: 6px;
  }

  #user-list::-webkit-scrollbar-track,
  .messages-box::-webkit-scrollbar-track {
    background: #ecf0f1;
  }

  #user-list::-webkit-scrollbar-thumb,
  .messages-box::-webkit-scrollbar-thumb {
    background: #bdc3c7;
    border-radius: 3px;
  }

  #user-list::-webkit-scrollbar-thumb:hover,
  .messages-box::-webkit-scrollbar-thumb:hover {
    background: #95a5a6;
  }
</style>

<div class="chat-container">
  <div class="chat-sidebar">
    <input type="text" id="search-user" placeholder="ðŸ” Search users..." class="chat-search">
    <div id="user-list">
      <div class="empty-chat">Loading users...</div>
    </div>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <h4 id="chat-receiver-name">Select a user to chat</h4>
    </div>
    <div id="messages" class="messages-box">
      <div class="empty-chat">ðŸ‘‹ Select a user to start chatting</div>
    </div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Type your message..." maxlength="500">
      <button id="send-btn" class="btn btn-primary">ðŸ“¤ Send</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io();

const sendButton = document.getElementById('send-btn');
const messageInput = document.getElementById('message-input');
const messagesContainer = document.getElementById('messages');
const userList = document.getElementById('user-list');
const searchInput = document.getElementById('search-user');

let activeReceiver = null;
let allUsers = [];  // Store all users for manipulation
let recentUsers = [];  // Track users who have messaged us
let unreadCount = {};  // Track unread message count per sender

// Show notification popup
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerText = message;
  document.body.appendChild(notification);
  
  console.log(`[NOTIFY] ${type.toUpperCase()}: ${message}`);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// Load unread messages on page load
async function loadUnreadMessages() {
  try {
    console.log('[UNREAD] Fetching unread messages...');
    const response = await fetch('/api/chat/unread');
    const unreadMessages = await response.json();
    
    console.log(`[UNREAD] Found ${unreadMessages.length} unread messages`);
    
    if (unreadMessages.length > 0) {
      // Group by sender
      const bySender = {};
      unreadMessages.forEach(msg => {
        if (!bySender[msg.sender]) {
          bySender[msg.sender] = [];
        }
        bySender[msg.sender].push(msg);
      });
      
      // Show notification and add to recent for each sender
      Object.entries(bySender).forEach(([sender, messages]) => {
        unreadCount[sender] = messages.length;
        addToRecentUsers(sender, sender);
        showNotification(`You have ${messages.length} unread message(s) from ${sender}`, 'info');
        console.log(`[UNREAD] ${sender}: ${messages.length} unread messages`);
      });
      
      // Refresh user list to show recent and unread badges
      loadUsers('');
    }
  } catch (error) {
    console.error('[UNREAD] Error loading unread messages:', error);
  }
}

// Add or move user to recent list
function addToRecentUsers(username, displayName) {
  // Remove if already in recent
  recentUsers = recentUsers.filter(u => u.username !== username);
  
  // Add to top
  recentUsers.unshift({
    username: username,
    display_name: displayName,
    is_recent: true
  });
  
  console.log(`[RECENT] Added ${username} to recent users. Total: ${recentUsers.length}`);
  
  // Keep only last 5 recent users
  if (recentUsers.length > 5) {
    recentUsers.pop();
  }
}

// Load users on page initialization
async function loadUsers(searchTerm = '') {
  try {
    console.log(`[JS] Loading users with search term: '${searchTerm}'`);
    const response = await fetch(`/api/chat/users/search?search=${encodeURIComponent(searchTerm)}`);
    console.log(`[JS] Response status: ${response.status}`);
    
    const data = await response.json();
    console.log(`[JS] Response data:`, data);
    
    // Ensure data is an array
    let users = [];
    if (Array.isArray(data)) {
      users = data;
    } else if (data && typeof data === 'object' && data.users) {
      users = data.users;
    } else if (data && typeof data === 'object') {
      // If it's an object but not the expected structure, try to convert it
      users = [];
    }
    
    allUsers = users;  // Store all users
    console.log(`[JS] Processing ${users.length} users`);
    displayUsers(users, searchTerm);
  } catch (error) {
    console.error('[JS] Error loading users:', error);
    displayUsers([]);
  }
}

// Display users in the user list
function displayUsers(users, searchTerm = '') {
  console.log(`[JS] displayUsers called with ${users.length} users, search: '${searchTerm}'`);
  console.log('[JS] Users data:', users);
  
  userList.innerHTML = '';
  
  // If searching, only show matching users (not recent)
  if (searchTerm) {
    if (!Array.isArray(users) || users.length === 0) {
      const noUsersMessage = document.createElement('div');
      noUsersMessage.innerText = 'No users found';
      noUsersMessage.style.color = '#999';
      noUsersMessage.style.padding = '10px';
      userList.appendChild(noUsersMessage);
      return;
    }
    
    users.forEach(user => createUserElement(user, false));
  } else {
    // Show recent users first (if any)
    if (recentUsers.length > 0) {
      const recentHeader = document.createElement('div');
      recentHeader.className = 'recent-users-header';
      recentHeader.innerText = 'Recent Conversations';
      userList.appendChild(recentHeader);
      
      recentUsers.forEach(user => createUserElement(user, true));
    }
    
    // Show all users
    if (allUsers.length > 0) {
      if (recentUsers.length > 0) {
        const allHeader = document.createElement('div');
        allHeader.className = 'recent-users-header';
        allHeader.innerText = 'All Users';
        userList.appendChild(allHeader);
      }
      
      allUsers.forEach(user => createUserElement(user, false));
    } else if (recentUsers.length === 0) {
      const noUsersMessage = document.createElement('div');
      noUsersMessage.innerText = 'No users found';
      noUsersMessage.style.color = '#999';
      noUsersMessage.style.padding = '10px';
      userList.appendChild(noUsersMessage);
    }
  }
}

// Create a user list item element
function createUserElement(user, isRecent = false) {
  try {
    const userItem = document.createElement('div');
    userItem.classList.add('user-item');
    if (isRecent) userItem.classList.add('recent');
    userItem.dataset.id = user.username;

    const userNameContainer = document.createElement('div');
    userNameContainer.classList.add('user-name-container');
    
    const userName = document.createElement('span');
    userName.classList.add('user-name');
    userName.innerText = user.display_name || user.username;

    // Add unread badge if there are unread messages
    if (unreadCount[user.username] && unreadCount[user.username] > 0) {
      const badge = document.createElement('span');
      badge.classList.add('unread-badge');
      badge.innerText = unreadCount[user.username];
      userNameContainer.appendChild(userName);
      userNameContainer.appendChild(badge);
    } else {
      userNameContainer.appendChild(userName);
    }

    const userDept = document.createElement('small');
    userDept.classList.add('user-dept');
    userDept.innerText = user.department || 'No Department';

    userItem.appendChild(userNameContainer);
    userItem.appendChild(userDept);
    userList.appendChild(userItem);

    // Add click event to select user
    userItem.addEventListener('click', async () => {
      document.querySelectorAll('.user-item').forEach(u => u.classList.remove('active'));
      userItem.classList.add('active');
      activeReceiver = user.username;
      
      // Clear and load message history
      messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading chat with ' + user.display_name + '...</div>';
      await loadMessageHistory(user.username);
      
      // Mark all messages from this user as read
      if (unreadCount[user.username] && unreadCount[user.username] > 0) {
        await fetch(`/api/chat/mark-all-read/${encodeURIComponent(user.username)}`, { method: 'POST' });
        delete unreadCount[user.username];
        loadUsers('');  // Refresh to remove badge
      }
    });
  } catch (e) {
    console.error('[JS] Error processing user:', e);
  }
}

// Load message history from database
async function loadMessageHistory(receiverUsername) {
  try {
    console.log(`[MSG] Loading message history with ${receiverUsername}`);
    const response = await fetch(`/api/chat/messages/${encodeURIComponent(receiverUsername)}`);
    const messages = await response.json();
    
    console.log(`[MSG] Loaded ${messages.length} messages`);
    messagesContainer.innerHTML = '';
    
    if (messages.length === 0) {
      messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No messages yet. Start the conversation!</div>';
      return;
    }
    
    // Display all messages
    messages.forEach(msg => {
      displayMessageInChat(msg);
    });
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  } catch (error) {
    console.error('[MSG] Error loading message history:', error);
    messagesContainer.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Error loading messages</div>';
  }
}

// Display a single message in the chat
function displayMessageInChat(data) {
  const messageElement = document.createElement('div');
  messageElement.style.padding = '10px';
  messageElement.style.marginBottom = '5px';
  messageElement.style.borderRadius = '5px';
  
  if (data.sender === '{{ session["user_id"] }}') {
    messageElement.style.backgroundColor = '#d4edda';
    messageElement.style.textAlign = 'right';
    messageElement.innerHTML = `<strong>You:</strong> ${data.message}<br><small style="color:#666;">${data.timestamp || ''}</small>`;
  } else {
    messageElement.style.backgroundColor = '#f0f0f0';
    messageElement.innerHTML = `<strong>${data.sender}:</strong> ${data.message}<br><small style="color:#666;">${data.timestamp || ''}</small>`;
  }
  
  messagesContainer.appendChild(messageElement);
}

// Load users when page loads
window.addEventListener('load', async () => {
  await loadUnreadMessages();  // Load unread messages first
  loadUsers();  // Then load all users
});

// Fetch and display users dynamically based on search input
searchInput.addEventListener('input', (e) => {
  const searchTerm = e.target.value.trim();
  loadUsers(searchTerm);
});

// Send message to the selected user
sendButton.addEventListener('click', () => {
  const message = messageInput.value.trim();
  if (!message || !activeReceiver) {
    alert('Please select a user and type a message.');
    return;
  }

  socket.emit('send_message', {
    sender: '{{ session["user_id"] }}',
    receiver: activeReceiver,
    message: message
  });

  messageInput.value = '';
});

// Listen for incoming messages (real-time)
socket.on('receive_message', (data) => {
  console.log('[SOCKET] Received message:', data);
  
  // Add sender to recent users if it's not from us (i.e., we're receiving it, not our own message)
  if (data.sender !== '{{ session["user_id"] }}') {
    // Track unread count
    if (!unreadCount[data.sender]) {
      unreadCount[data.sender] = 0;
    }
    unreadCount[data.sender]++;
    
    addToRecentUsers(data.sender, data.sender);
    
    // Show notification only if not viewing this conversation
    if (activeReceiver !== data.sender) {
      showNotification(`New message from ${data.sender}`, 'info');
      loadUsers('');  // Refresh to show unread badge
    }
  }
  
  // Only display if it's for the currently active conversation
  if (activeReceiver && (data.sender === activeReceiver || data.receiver === activeReceiver)) {
    displayMessageInChat(data);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
});

// Notify when recipient receives a message
socket.on('message_sent', (data) => {
  console.log('[SOCKET] Message sent successfully:', data);
  showNotification('Message sent', 'info');
});

// Listen for errors
socket.on('error', (data) => {
  console.error('Socket error:', data);
  showNotification(`Error: ${data.message}`, 'error');
});
</script>
{% endblock %}
