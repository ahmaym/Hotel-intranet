{% extends "base.html" %}
{% block content %}
<div class="chat-container">
  <div class="chat-sidebar">
    <input type="text" id="search-user" placeholder="Search for a user..." class="chat-search">
    <div id="user-list">
      {% for user in users %}
      <div class="user-item" data-id="{{ user.username }}">
        <span class="user-name">{{ user.display_name }}</span>
        <small class="user-dept">{{ user.department }}</small>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="chat-main">
    <div id="messages" class="messages-box"></div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Type your message...">
      <button id="send-btn" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io();

const sendButton = document.getElementById('send-btn');
const messageInput = document.getElementById('message-input');
const messagesContainer = document.getElementById('messages');
const userList = document.getElementById('user-list');
const searchInput = document.getElementById('search-user');

let activeReceiver = null;

// Fetch and display users dynamically based on search input
searchInput.addEventListener('input', async () => {
  const searchTerm = searchInput.value.toLowerCase();

  try {
    const response = await fetch(`/chat?search=${encodeURIComponent(searchTerm)}`);
    const users = await response.json();

    // Clear the user list
    userList.innerHTML = '';

    if (users.length === 0) {
      const noUsersMessage = document.createElement('div');
      noUsersMessage.id = 'no-users-message';
      noUsersMessage.innerText = 'No users found';
      noUsersMessage.style.color = 'red';
      userList.appendChild(noUsersMessage);
    } else {
      users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.classList.add('user-item');
        userItem.dataset.id = user.username;

        const userName = document.createElement('span');
        userName.classList.add('user-name');
        userName.innerText = user.display_name;

        const userDept = document.createElement('small');
        userDept.classList.add('user-dept');
        userDept.innerText = user.department;

        userItem.appendChild(userName);
        userItem.appendChild(userDept);
        userList.appendChild(userItem);

        // Add click event to select user
        userItem.addEventListener('click', () => {
          document.querySelectorAll('.user-item').forEach(u => u.classList.remove('active'));
          userItem.classList.add('active');
          activeReceiver = user.username;
          messagesContainer.innerHTML = ''; // Clear previous messages
        });
      });
    }
  } catch (error) {
    console.error('Error fetching users:', error);
  }
});

// Send message
sendButton.addEventListener('click', () => {
  const message = messageInput.value.trim();
  if (message && activeReceiver) {
    socket.emit('send_message', {
      sender: "{{ session['user_id'] }}",
      receiver: activeReceiver,
      message: message
    });
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', 'sent');
    msgDiv.innerText = message;
    messagesContainer.appendChild(msgDiv);
    messageInput.value = '';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
});

// Receive message
socket.on('receive_message', (data) => {
  if (data.receiver === "{{ session['user_id'] }}" || data.sender === "{{ session['user_id'] }}") {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', data.sender === "{{ session['user_id'] }}" ? 'sent' : 'received');
    msgDiv.innerText = `${data.sender_name}: ${data.message}`;
    messagesContainer.appendChild(msgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Notification in the user list
  if (data.receiver === "{{ session['user_id'] }}") {
    const userItem = document.querySelector(`.user-item[data-id='${data.sender}']`);
    if (userItem && !userItem.classList.contains('active')) {
      userItem.classList.add('new-message');
    }
  }
});
</script>
{% endblock %}
