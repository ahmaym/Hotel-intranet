{% extends "base.html" %}
{% block content %}
<style>
  .notification {
    position: fixed; top: 80px; right: 20px; padding: 12px 16px; border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; font-size: 14px; font-weight: 500;
    animation: slideIn 0.3s ease;
  }
  .notification.success { background: #059669; color: white; }
  .notification.error { background: #dc2626; color: white; }
  .notification.info { background: #0284c7; color: white; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  
  /* User list items */
  .user-item { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s; }
  .user-item:hover { background: #f1f5f9; }
  .user-item.active { background: #e0f2fe; border-left: 3px solid #0284c7; }
  .user-item.recent { background: #ecfdf5; border-left: 3px solid #059669; }
  .user-name-container { display: flex; justify-content: space-between; align-items: center; }
  .user-name { font-weight: 600; color: #1e293b; font-size: 14px; }
  .user-dept { font-size: 12px; color: #64748b; display: block; margin-top: 2px; }
  .unread-badge { background: #ef4444; color: white; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
  .recent-users-header { padding: 8px 16px; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
</style>

<!-- Chat Container -->
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden" style="height: calc(100vh - 220px); min-height: 500px;">
  <div class="flex h-full">
    
    <!-- Sidebar - User List -->
    <div class="w-80 border-r border-slate-200 flex flex-col bg-slate-50">
      <!-- Search -->
      <div class="p-3 border-b border-slate-200">
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
          <input type="text" id="search-user" placeholder="Search users..."
            class="w-full pl-9 pr-4 py-2.5 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-white">
        </div>
      </div>
      
      <!-- User List -->
      <div id="user-list" class="flex-1 overflow-y-auto">
        <div class="flex items-center justify-center h-32 text-slate-400 text-sm">
          <i data-lucide="loader-2" class="w-5 h-5 animate-spin mr-2"></i> Loading users...
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-white">
      <!-- Chat Header -->
      <div class="px-5 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
            <i data-lucide="user" class="w-5 h-5 text-slate-500"></i>
          </div>
          <div>
            <h4 id="chat-receiver-name" class="font-semibold text-slate-800">Select a user</h4>
            <p class="text-xs text-slate-500">Click on a user to start chatting</p>
          </div>
        </div>
      </div>

      <!-- Messages Container -->
      <div id="messages" class="flex-1 overflow-y-auto p-5 space-y-4 bg-gradient-to-b from-slate-50 to-white">
        <div class="flex flex-col items-center justify-center h-full text-slate-400">
          <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
            <i data-lucide="message-square" class="w-8 h-8"></i>
          </div>
          <p class="font-medium">No conversation selected</p>
          <p class="text-sm">Choose a user from the list to start chatting</p>
        </div>
      </div>

      <!-- Message Input -->
      <div class="p-4 border-t border-slate-200 bg-white">
        <div class="flex gap-3">
          <input type="text" id="message-input" placeholder="Type your message..." maxlength="500"
            class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 text-sm">
          <button id="send-btn" class="inline-flex items-center gap-2 px-5 py-2.5 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors">
            <i data-lucide="send" class="w-4 h-4"></i> Send
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const socket = io();

  const sendButton = document.getElementById('send-btn');
  const messageInput = document.getElementById('message-input');
  const messagesContainer = document.getElementById('messages');
  const userList = document.getElementById('user-list');
  const searchInput = document.getElementById('search-user');

  let activeReceiver = null;
  let allUsers = [];  // Store all users for manipulation
  let recentUsers = [];  // Track users who have messaged us
  let unreadCount = {};  // Track unread message count per sender

  // Show notification popup
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerText = message;
    document.body.appendChild(notification);

    console.log(`[NOTIFY] ${type.toUpperCase()}: ${message}`);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Load unread messages on page load
  async function loadUnreadMessages() {
    try {
      console.log('[UNREAD] Fetching unread messages...');
      const response = await fetch('/api/chat/unread');
      const unreadMessages = await response.json();

      console.log(`[UNREAD] Found ${unreadMessages.length} unread messages`);

      if (unreadMessages.length > 0) {
        // Group by sender
        const bySender = {};
        unreadMessages.forEach(msg => {
          if (!bySender[msg.sender]) {
            bySender[msg.sender] = [];
          }
          bySender[msg.sender].push(msg);
        });

        // Show notification and add to recent for each sender
        Object.entries(bySender).forEach(([sender, messages]) => {
          unreadCount[sender] = messages.length;
          addToRecentUsers(sender, sender);
          showNotification(`You have ${messages.length} unread message(s) from ${sender}`, 'info');
          console.log(`[UNREAD] ${sender}: ${messages.length} unread messages`);
        });

        // Refresh user list to show recent and unread badges
        loadUsers('');
      }
    } catch (error) {
      console.error('[UNREAD] Error loading unread messages:', error);
    }
  }

  // Add or move user to recent list
  function addToRecentUsers(username, displayName) {
    // Remove if already in recent
    recentUsers = recentUsers.filter(u => u.username !== username);

    // Add to top
    recentUsers.unshift({
      username: username,
      display_name: displayName,
      is_recent: true
    });

    console.log(`[RECENT] Added ${username} to recent users. Total: ${recentUsers.length}`);

    // Keep only last 5 recent users
    if (recentUsers.length > 5) {
      recentUsers.pop();
    }
  }

  // Load users on page initialization
  async function loadUsers(searchTerm = '') {
    try {
      console.log(`[JS] Loading users with search term: '${searchTerm}'`);
      const response = await fetch(`/api/chat/users/search?search=${encodeURIComponent(searchTerm)}`);
      console.log(`[JS] Response status: ${response.status}`);

      const data = await response.json();
      console.log(`[JS] Response data:`, data);

      // Ensure data is an array
      let users = [];
      if (Array.isArray(data)) {
        users = data;
      } else if (data && typeof data === 'object' && data.users) {
        users = data.users;
      } else if (data && typeof data === 'object') {
        // If it's an object but not the expected structure, try to convert it
        users = [];
      }

      allUsers = users;  // Store all users
      console.log(`[JS] Processing ${users.length} users`);
      displayUsers(users, searchTerm);
    } catch (error) {
      console.error('[JS] Error loading users:', error);
      displayUsers([]);
    }
  }

  // Display users in the user list
  function displayUsers(users, searchTerm = '') {
    console.log(`[JS] displayUsers called with ${users.length} users, search: '${searchTerm}'`);
    console.log('[JS] Users data:', users);

    userList.innerHTML = '';

    // If searching, only show matching users (not recent)
    if (searchTerm) {
      if (!Array.isArray(users) || users.length === 0) {
        const noUsersMessage = document.createElement('div');
        noUsersMessage.innerText = 'No users found';
        noUsersMessage.style.color = '#999';
        noUsersMessage.style.padding = '10px';
        userList.appendChild(noUsersMessage);
        return;
      }

      users.forEach(user => createUserElement(user, false));
    } else {
      // Show recent users first (if any)
      if (recentUsers.length > 0) {
        const recentHeader = document.createElement('div');
        recentHeader.className = 'recent-users-header';
        recentHeader.innerText = 'Recent Conversations';
        userList.appendChild(recentHeader);

        recentUsers.forEach(user => createUserElement(user, true));
      }

      // Show all users
      if (allUsers.length > 0) {
        if (recentUsers.length > 0) {
          const allHeader = document.createElement('div');
          allHeader.className = 'recent-users-header';
          allHeader.innerText = 'All Users';
          userList.appendChild(allHeader);
        }

        allUsers.forEach(user => createUserElement(user, false));
      } else if (recentUsers.length === 0) {
        const noUsersMessage = document.createElement('div');
        noUsersMessage.innerText = 'No users found';
        noUsersMessage.style.color = '#999';
        noUsersMessage.style.padding = '10px';
        userList.appendChild(noUsersMessage);
      }
    }
  }

  // Create a user list item element
  function createUserElement(user, isRecent = false) {
    try {
      const userItem = document.createElement('div');
      userItem.classList.add('user-item');
      if (isRecent) userItem.classList.add('recent');
      userItem.dataset.id = user.username;

      const userNameContainer = document.createElement('div');
      userNameContainer.classList.add('user-name-container');

      const userName = document.createElement('span');
      userName.classList.add('user-name');
      userName.innerText = user.display_name || user.username;

      // Add unread badge if there are unread messages
      if (unreadCount[user.username] && unreadCount[user.username] > 0) {
        const badge = document.createElement('span');
        badge.classList.add('unread-badge');
        badge.innerText = unreadCount[user.username];
        userNameContainer.appendChild(userName);
        userNameContainer.appendChild(badge);
      } else {
        userNameContainer.appendChild(userName);
      }

      const userDept = document.createElement('small');
      userDept.classList.add('user-dept');
      userDept.innerText = user.department || 'No Department';

      userItem.appendChild(userNameContainer);
      userItem.appendChild(userDept);
      userList.appendChild(userItem);

      // Add click event to select user
      userItem.addEventListener('click', async () => {
        document.querySelectorAll('.user-item').forEach(u => u.classList.remove('active'));
        userItem.classList.add('active');
        activeReceiver = user.username;

        // Clear and load message history
        messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading chat with ' + user.display_name + '...</div>';
        await loadMessageHistory(user.username);

        // Mark all messages from this user as read
        if (unreadCount[user.username] && unreadCount[user.username] > 0) {
          await fetch(`/api/chat/mark-all-read/${encodeURIComponent(user.username)}`, { method: 'POST' });
          delete unreadCount[user.username];
          loadUsers('');  // Refresh to remove badge
        }
      });
    } catch (e) {
      console.error('[JS] Error processing user:', e);
    }
  }

  // Load message history from database
  async function loadMessageHistory(receiverUsername) {
    try {
      console.log(`[MSG] Loading message history with ${receiverUsername}`);
      const response = await fetch(`/api/chat/messages/${encodeURIComponent(receiverUsername)}`);
      const messages = await response.json();

      console.log(`[MSG] Loaded ${messages.length} messages`);
      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No messages yet. Start the conversation!</div>';
        return;
      }

      // Display all messages
      messages.forEach(msg => {
        displayMessageInChat(msg);
      });

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } catch (error) {
      console.error('[MSG] Error loading message history:', error);
      messagesContainer.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Error loading messages</div>';
    }
  }

  // Display a single message in the chat
  function displayMessageInChat(data) {
    const messageElement = document.createElement('div');
    messageElement.style.padding = '10px';
    messageElement.style.marginBottom = '5px';
    messageElement.style.borderRadius = '5px';

    if (data.sender === '{{ session["user_id"] }}') {
      messageElement.style.backgroundColor = '#d4edda';
      messageElement.style.textAlign = 'right';
      messageElement.innerHTML = `<strong>You:</strong> ${data.message}<br><small style="color:#666;">${data.timestamp || ''}</small>`;
    } else {
      messageElement.style.backgroundColor = '#f0f0f0';
      messageElement.innerHTML = `<strong>${data.sender}:</strong> ${data.message}<br><small style="color:#666;">${data.timestamp || ''}</small>`;
    }

    messagesContainer.appendChild(messageElement);
  }

  // Load users when page loads
  window.addEventListener('load', async () => {
    await loadUnreadMessages();  // Load unread messages first
    loadUsers();  // Then load all users
  });

  // Fetch and display users dynamically based on search input
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    loadUsers(searchTerm);
  });

  // Send message to the selected user
  sendButton.addEventListener('click', () => {
    const message = messageInput.value.trim();
    if (!message || !activeReceiver) {
      alert('Please select a user and type a message.');
      return;
    }

    socket.emit('send_message', {
      sender: '{{ session["user_id"] }}',
      receiver: activeReceiver,
      message: message
    });

    messageInput.value = '';
  });

  // Listen for incoming messages (real-time)
  socket.on('receive_message', (data) => {
    console.log('[SOCKET] Received message:', data);

    // Add sender to recent users if it's not from us (i.e., we're receiving it, not our own message)
    if (data.sender !== '{{ session["user_id"] }}') {
      // Track unread count
      if (!unreadCount[data.sender]) {
        unreadCount[data.sender] = 0;
      }
      unreadCount[data.sender]++;

      addToRecentUsers(data.sender, data.sender);

      // Show notification only if not viewing this conversation
      if (activeReceiver !== data.sender) {
        showNotification(`New message from ${data.sender}`, 'info');
        loadUsers('');  // Refresh to show unread badge
      }
    }

    // Only display if it's for the currently active conversation
    if (activeReceiver && (data.sender === activeReceiver || data.receiver === activeReceiver)) {
      displayMessageInChat(data);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  });

  // Notify when recipient receives a message
  socket.on('message_sent', (data) => {
    console.log('[SOCKET] Message sent successfully:', data);
    showNotification('Message sent', 'info');
  });

  // Listen for errors
  socket.on('error', (data) => {
    console.error('Socket error:', data);
    showNotification(`Error: ${data.message}`, 'error');
  });
</script>
{% endblock %}